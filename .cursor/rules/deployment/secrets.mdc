---
id: deployment/secrets
category: deployment
title: Secrets
status: draft
tags: [secrets, security, api-keys, tokens, encryption]
---

# Secrets

**Objective**: Secure sensitive keys (Stripe, emails, JWT, API tokens) and prevent any data leaks.
**Context**: To be applied for deployment and continuous integration stages.

## Explanation

Secrets are sensitive data that must **never** be publicly exposed:
- Private API keys (Stripe, SendGrid, etc.)
- Authentication tokens
- Signature secrets (JWT, webhooks)
- Database credentials
- SMTP passwords

**Absolute rules:**
- ❌ Never commit secrets to Git.
- ❌ Never hardcode secrets in code.
- ❌ Never put secrets in public variables (`NEXT_PUBLIC_*`).
- ✅ Always store secrets in environment variables.
- ✅ Use different secrets per environment.
- ✅ Mark secrets as "Sensitive" in Vercel.
- ✅ Regular rotation of critical secrets.

**Common types of secrets:**

| Secret                  | Where to store it           | Example                         |
| ----------------------- | --------------------------- | ------------------------------- |
| Stripe Secret Key       | `STRIPE_SECRET_KEY`         | `sk_live_xxx`                   |
| Stripe Webhook Secret   | `STRIPE_WEBHOOK_SECRET`     | `whsec_xxx`                     |
| Database URL            | `DATABASE_URL`              | `postgresql://user:pass@...`    |
| JWT Secret              | `JWT_SECRET`                | Random string 32+ characters    |
| SMTP Password           | `SMTP_PASSWORD`             | Mail service password           |
| API Tokens              | `API_TOKEN_XXX`             | Third-party service tokens      |

## Practical Implementation Example

**.env.local (local, gitignored):**

```bash
# Test mode locally
STRIPE_SECRET_KEY="sk_test_..."
STRIPE_WEBHOOK_SECRET="whsec_test_..."
DATABASE_URL="postgresql://localhost:5432/dev"
JWT_SECRET="local-dev-secret-min-32-chars-long"
SMTP_PASSWORD="local-password"
```

**Vercel configuration (Production):**

```
Secrets marked as "Sensitive" (not visible after creation):

STRIPE_SECRET_KEY = sk_live_xxx
STRIPE_WEBHOOK_SECRET = whsec_xxx
DATABASE_URL = postgresql://prod.db/app?sslmode=require
JWT_SECRET = [randomly generated, 64 characters]
SMTP_PASSWORD = [actual password]
```

**Generating secure secrets:**

```bash
# JWT secret (64 random characters)
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"

# Or via OpenSSL
openssl rand -hex 32
```

**Validation and usage in code:**

```ts
// config/env.ts
import { z } from 'zod';

const envSchema = z.object({
  STRIPE_SECRET_KEY: z.string().refine(
    (val) => val.startsWith('sk_'),
    'Invalid Stripe secret key format'
  ),
  STRIPE_WEBHOOK_SECRET: z.string().refine(
    (val) => val.startsWith('whsec_'),
    'Invalid Stripe webhook secret format'
  ),
  JWT_SECRET: z.string().min(32, 'JWT secret must be at least 32 characters'),
  DATABASE_URL: z.string().url(),
  SMTP_PASSWORD: z.string().min(8),
});

export const env = envSchema.parse(process.env);
```

**Log protection:**

```ts
// ❌ Avoid - exposes the secret in logs
console.log('Stripe key:', process.env.STRIPE_SECRET_KEY);

// ✅ Correct - masks the secret
console.log('Stripe key:', process.env.STRIPE_SECRET_KEY?.slice(0, 7) + '...');
```

**Secret verification at startup:**

```ts
// app/api/health/route.ts
import { env } from '@/config/env';

export async function GET() {
  try {
    // Validates that all secrets are present
    const secretsPresent = {
      stripe: !!env.STRIPE_SECRET_KEY,
      database: !!env.DATABASE_URL,
      jwt: !!env.JWT_SECRET,
    };

    return Response.json({ status: 'ok', secrets: secretsPresent });
  } catch (error) {
    return Response.json({ status: 'error', message: 'Missing secrets' }, { status: 500 });
  }
}
```

## Variants or Exceptions

- **Automatic rotation**: Implement a secret rotation system (e.g., JWT secret rotation with grace period).
- **External vault**: Use HashiCorp Vault, AWS Secrets Manager to manage secrets.
- **Secrets per feature**: Prefix secrets by context (`PAYMENT_API_KEY`, `EMAIL_API_KEY`).
- **GitHub secrets**: Store in GitHub Secrets for CI/CD workflows.
- **Additional encryption**: Encrypt certain database data with a master key.

## Links / References

- [Vercel Environment Variables - Sensitive](https://vercel.com/docs/concepts/projects/environment-variables#sensitive-environment-variables)
- [OWASP Secrets Management](https://cheatsheetseries.owasp.org/cheatsheets/Secrets_Management_Cheat_Sheet.html)
- [GitHub Encrypted Secrets](https://docs.github.com/en/actions/security-guides/encrypted-secrets)
- Internal documentation: `.cursor/docs/references.md`
