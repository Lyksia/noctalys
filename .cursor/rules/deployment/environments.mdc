---
id: deployment/environments
category: deployment
title: Environments
status: draft
tags: [environments, dev, staging, production, vercel]
---

# Environments

**Objective**: Manage environments (development, preview, production) in a consistent and secure manner.
**Context**: To be applied for deployment and continuous integration stages.

## Explanation

Each project must clearly distinguish three environments:

| Environment   | Branch   | URL                     | Usage                              |
| ------------- | -------- | ----------------------- | ---------------------------------- |
| Development   | Local    | `localhost:3000`        | Local development                  |
| Preview       | Feature  | `*.vercel.app`          | Test PRs before merge              |
| Staging       | `dev`    | `staging.domain.com`    | Pre-production environment         |
| Production    | `main`   | `domain.com`            | Public environment                 |

**Key principles:**
- Each environment has its own environment variables.
- Secrets are never committed to Git.
- Preview environments use test resources (API sandbox, Stripe test mode, etc.).
- Production uses real resources with secure secrets.

**Variable management:**
- **Local**: `.env.local` (gitignored)
- **Preview/Staging/Production**: Vercel Dashboard â†’ Environment Variables

## Practical Implementation Example

**.env.example (versioned in Git):**

```bash
# Database
DATABASE_URL="postgresql://user:password@localhost:5432/db"

# API
NEXT_PUBLIC_API_URL="http://localhost:3000/api"

# Stripe
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY="pk_test_..."
STRIPE_SECRET_KEY="sk_test_..."
STRIPE_WEBHOOK_SECRET="whsec_..."

# Email
SMTP_HOST="smtp.example.com"
SMTP_PORT="587"
SMTP_USER="user@example.com"
SMTP_PASSWORD="password"
EMAIL_FROM="noreply@example.com"

# App
NEXT_PUBLIC_APP_URL="http://localhost:3000"
```

**.env.local (local development, gitignored):**

```bash
DATABASE_URL="postgresql://localhost:5432/myapp_dev"
NEXT_PUBLIC_API_URL="http://localhost:3000/api"
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY="pk_test_local..."
STRIPE_SECRET_KEY="sk_test_local..."
```

**Vercel configuration per environment:**

```
Production (main):
  DATABASE_URL=postgresql://prod.db/myapp
  NEXT_PUBLIC_API_URL=https://api.domain.com
  STRIPE_SECRET_KEY=sk_live_xxx (encrypted)

Preview (feature/*):
  DATABASE_URL=postgresql://preview.db/myapp_preview
  NEXT_PUBLIC_API_URL=https://api-preview.domain.com
  STRIPE_SECRET_KEY=sk_test_xxx
  
Development (dev):
  DATABASE_URL=postgresql://staging.db/myapp_staging
  NEXT_PUBLIC_API_URL=https://api-staging.domain.com
  STRIPE_SECRET_KEY=sk_test_xxx
```

**Environment detection in code:**

```ts
export const ENV = {
  isDevelopment: process.env.NODE_ENV === 'development',
  isProduction: process.env.NODE_ENV === 'production',
  isPreview: process.env.VERCEL_ENV === 'preview',
  apiUrl: process.env.NEXT_PUBLIC_API_URL,
} as const;
```

## Variants or Exceptions

- **Additional environments**: Add dedicated `staging`, `QA`, etc.
- **Feature flags**: Use tools like LaunchDarkly to enable/disable features per environment.
- **Shared databases**: Use table prefixes or distinct PostgreSQL schemas.
- **Dynamic URLs**: Use `VERCEL_URL` to automatically generate the base URL.

## Links / References

- [Vercel Environment Variables](https://vercel.com/docs/concepts/projects/environment-variables)
- [Next.js Environment Variables](https://nextjs.org/docs/basic-features/environment-variables)
- Internal documentation: `.cursor/docs/references.md`
