---
id: utils/env
category: utils
title: Helpers de variables d'environnement
status: draft
tags: [utils, env, environment, configuration, validation]
---

# Helpers de variables d'environnement

**Objectif** : Valider et typer les variables d'environnement pour garantir sécurité et cohérence.
**Contexte** : À appliquer pour standardiser les helpers et fonctions partagées.

## Explication

Les variables d'environnement doivent être validées au démarrage de l'application pour éviter les erreurs runtime. Les helpers d'environnement centralisent cette validation avec Zod.

**Principes :**

* Valider toutes les variables au démarrage
* Typer les variables avec Zod
* Échouer rapidement si une variable manque
* Différencier les variables publiques (client) et privées (serveur)
* Ne jamais exposer les secrets côté client

**Variables d'environnement courantes :**

* **Next.js** : `NEXT_PUBLIC_*` pour le client, autres pour le serveur
* **Database** : `DATABASE_URL`
* **API** : `API_URL`, `API_KEY`
* **Auth** : `NEXTAUTH_SECRET`, `NEXTAUTH_URL`
* **Stripe** : `STRIPE_SECRET_KEY`, `NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY`

## Exemple de mise en pratique

```ts
// src/utils/env/schema.ts
import { z } from 'zod';

/**
 * Schéma des variables d'environnement serveur
 */
const serverEnvSchema = z.object({
  NODE_ENV: z.enum(['development', 'production', 'test']),
  DATABASE_URL: z.string().url(),
  NEXTAUTH_SECRET: z.string().min(32),
  NEXTAUTH_URL: z.string().url(),
  STRIPE_SECRET_KEY: z.string().startsWith('sk_'),
  STRIPE_WEBHOOK_SECRET: z.string().startsWith('whsec_'),
  SMTP_HOST: z.string(),
  SMTP_PORT: z.coerce.number(),
  SMTP_USER: z.string().email(),
  SMTP_PASSWORD: z.string(),
});

/**
 * Schéma des variables d'environnement client (NEXT_PUBLIC_*)
 */
const clientEnvSchema = z.object({
  NEXT_PUBLIC_APP_URL: z.string().url(),
  NEXT_PUBLIC_API_URL: z.string().url(),
  NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: z.string().startsWith('pk_'),
});

/**
 * Schéma complet (serveur + client)
 */
const envSchema = serverEnvSchema.merge(clientEnvSchema);

export type Env = z.infer<typeof envSchema>;
export type ServerEnv = z.infer<typeof serverEnvSchema>;
export type ClientEnv = z.infer<typeof clientEnvSchema>;

export { envSchema, serverEnvSchema, clientEnvSchema };

// src/utils/env/validate.ts
import { envSchema, serverEnvSchema, clientEnvSchema } from './schema';
import type { Env, ServerEnv, ClientEnv } from './schema';

/**
 * Valide toutes les variables d'environnement
 * @throws {Error} Si une variable est manquante ou invalide
 */
export function validateEnv(): Env {
  const parsed = envSchema.safeParse(process.env);

  if (!parsed.success) {
    console.error('❌ Variables d\'environnement invalides:');
    console.error(parsed.error.flatten().fieldErrors);
    throw new Error('Variables d\'environnement invalides');
  }

  return parsed.data;
}

/**
 * Valide les variables d'environnement serveur uniquement
 */
export function validateServerEnv(): ServerEnv {
  const parsed = serverEnvSchema.safeParse(process.env);

  if (!parsed.success) {
    throw new Error('Variables d\'environnement serveur invalides');
  }

  return parsed.data;
}

/**
 * Valide les variables d'environnement client uniquement
 */
export function validateClientEnv(): ClientEnv {
  const parsed = clientEnvSchema.safeParse(process.env);

  if (!parsed.success) {
    throw new Error('Variables d\'environnement client invalides');
  }

  return parsed.data;
}

// src/utils/env/index.ts
import { validateEnv } from './validate';

/**
 * Variables d'environnement validées et typées
 * Échoue au démarrage si une variable est manquante
 */
export const env = validateEnv();

export { validateEnv, validateServerEnv, validateClientEnv } from './validate';
export type { Env, ServerEnv, ClientEnv } from './schema';

// Usage dans le code

// ✅ Bon - Variables typées et validées
import { env } from '@/utils/env';

const dbUrl = env.DATABASE_URL;
const apiUrl = env.NEXT_PUBLIC_API_URL;

// ❌ Mauvais - Accès direct sans validation
const dbUrl = process.env.DATABASE_URL; // Type: string | undefined

// Configuration Next.js
// next.config.js
const { validateClientEnv } = require('./src/utils/env/validate');

// Valider les variables client au build
validateClientEnv();

module.exports = {
  // ... config
};

// Exemple de .env.example
/*
# Base de données
DATABASE_URL="postgresql://user:password@localhost:5432/mydb"

# NextAuth
NEXTAUTH_SECRET="votre-secret-de-32-caracteres-minimum"
NEXTAUTH_URL="http://localhost:3000"

# Stripe
STRIPE_SECRET_KEY="sk_test_..."
STRIPE_WEBHOOK_SECRET="whsec_..."
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY="pk_test_..."

# SMTP
SMTP_HOST="smtp.example.com"
SMTP_PORT="587"
SMTP_USER="noreply@example.com"
SMTP_PASSWORD="password"

# URLs publiques
NEXT_PUBLIC_APP_URL="http://localhost:3000"
NEXT_PUBLIC_API_URL="http://localhost:3000/api"
*/
```

## Variantes ou exceptions

* Pour des applications simples, la validation peut être allégée
* Les variables optionnelles doivent être marquées avec `.optional()`
* En développement, utiliser `.env.local` pour les secrets

## Liens / Références

* https://nextjs.org/docs/basic-features/environment-variables
* https://zod.dev/
* https://t3.gg/env
* Documentation interne : `/docs/environment.md`
