---
alwaysApply: false
description: Handle network and API errors uniformly
---

# Error Handling

**Objective**: Handle network and API errors uniformly to improve user experience and debugging.

**Context**: To apply for ensuring consistency in state and data management.

## Explanation

Consistent error handling is essential for good UX and effective debugging. All errors must be typed, logged, and displayed appropriately.

**Key principles:**

- **Error typing** with TypeScript
- **Clear error messages** for users
- **Logging** for debugging
- **Retry logic** for temporary errors
- **Fallbacks** for critical errors

## Practical Implementation Example

**Custom error type:**

```ts
// src/types/errors.ts
export class ApiError extends Error {
  constructor(
    message: string,
    public status: number,
    public code?: string,
    public details?: Record<string, string[]>
  ) {
    super(message);
    this.name = "ApiError";
  }
}

export function isApiError(error: unknown): error is ApiError {
  return error instanceof ApiError;
}
```

**Handling in service:**

```ts
// src/features/users/services/users-api.ts
import { apiClient } from "@/lib/axios";
import { AxiosError } from "axios";
import { ApiError } from "@/types/errors";
import type { User } from "../types";

export async function fetchUsers(): Promise<User[]> {
  try {
    const { data } = await apiClient.get<User[]>("/users");
    return data;
  } catch (error) {
    if (error instanceof AxiosError) {
      throw new ApiError(
        error.response?.data?.message || "Failed to fetch users",
        error.response?.status || 500,
        error.response?.data?.code,
        error.response?.data?.details
      );
    }
    throw error;
  }
}
```

**Handling in hook:**

```ts
// src/features/users/hooks/use-users.ts
import { useQuery } from "@tanstack/react-query";
import { fetchUsers } from "../services";
import { isApiError } from "@/types/errors";

export function useUsers() {
  return useQuery({
    queryKey: ["users"],
    queryFn: fetchUsers,
    retry: (failureCount, error) => {
      // Don't retry on client errors (4xx)
      if (isApiError(error) && error.status < 500) {
        return false;
      }
      // Retry up to 3 times for server errors
      return failureCount < 3;
    },
    retryDelay: (attemptIndex) => Math.min(1000 * 2 ** attemptIndex, 30000),
  });
}
```

**Display in component:**

```tsx
// src/features/users/components/user-list.tsx
import { useUsers } from "../hooks";
import { isApiError } from "@/types/errors";

export function UserList() {
  const { data: users, error, isLoading } = useUsers();

  if (isLoading) return <div>Loading...</div>;

  if (error) {
    if (isApiError(error)) {
      if (error.status === 404) {
        return <div>No users found</div>;
      }
      if (error.status === 403) {
        return <div>You don't have permission to view users</div>;
      }
      return <div>Error: {error.message}</div>;
    }
    return <div>An unexpected error occurred</div>;
  }

  return (
    <ul>
      {users?.map((user) => (
        <li key={user.id}>{user.name}</li>
      ))}
    </ul>
  );
}
```

**Error Boundary :**

```tsx
// src/components/error-boundary.tsx
"use client";

import { Component, ReactNode } from "react";

interface Props {
  children: ReactNode;
  fallback?: ReactNode;
}

interface State {
  hasError: boolean;
  error?: Error;
}

export class ErrorBoundary extends Component<Props, State> {
  constructor(props: Props) {
    super(props);
    this.state = { hasError: false };
  }

  static getDerivedStateFromError(error: Error): State {
    return { hasError: true, error };
  }

  componentDidCatch(error: Error, errorInfo: React.ErrorInfo) {
    console.error("Error caught by boundary:", error, errorInfo);
    // Send to monitoring service (Sentry, etc.)
  }

  render() {
    if (this.state.hasError) {
      return this.props.fallback || <div>Something went wrong</div>;
    }

    return this.props.children;
  }
}
```

**Toast for errors:**

```ts
// src/features/users/hooks/use-create-user.ts
import { useMutation, useQueryClient } from "@tanstack/react-query";
import { createUser } from "../services";
import { toast } from "sonner";
import { isApiError } from "@/types/errors";

export function useCreateUser() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: createUser,
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["users"] });
      toast.success("User created successfully");
    },
    onError: (error) => {
      if (isApiError(error)) {
        if (error.details) {
          // Display validation errors
          Object.entries(error.details).forEach(([field, messages]) => {
            messages.forEach((msg) => toast.error(`${field}: ${msg}`));
          });
        } else {
          toast.error(error.message);
        }
      } else {
        toast.error("An unexpected error occurred");
      }
    },
  });
}
```

**Fallback with default data:**

```ts
// src/features/config/hooks/use-config.ts
import { useQuery } from "@tanstack/react-query";
import { fetchConfig } from "../services";

const defaultConfig = {
  theme: "light",
  language: "en",
  timezone: "UTC",
};

export function useConfig() {
  return useQuery({
    queryKey: ["config"],
    queryFn: fetchConfig,
    placeholderData: defaultConfig,
    staleTime: Infinity,
  });
}
```

**Global error handling:**

```tsx
// app/layout.tsx
"use client";

import { QueryClientProvider, QueryClient } from "@tanstack/react-query";
import { toast } from "sonner";
import { isApiError } from "@/types/errors";

const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      onError: (error) => {
        console.error("Query error:", error);
        // Log to external service
      },
    },
    mutations: {
      onError: (error) => {
        console.error("Mutation error:", error);
        if (isApiError(error) && error.status >= 500) {
          toast.error("Server error. Please try again later.");
        }
      },
    },
  },
});

export default function RootLayout({ children }: { children: React.ReactNode }) {
  return (
    <html>
      <body>
        <QueryClientProvider client={queryClient}>{children}</QueryClientProvider>
      </body>
    </html>
  );
}
```

## Variants or Exceptions

- Critical errors may require redirection.
- Authentication errors should redirect to login page.

## Links / References

- [Error Handling Best Practices](https://tanstack.com/query/latest/docs/react/guides/query-cancellation)
- Internal documentation: `references.md`
