---
alwaysApply: false
description: Server-side email sending
---

# Nodemailer

**Objectif** : Standardiser l'usage de Nodemailer pour l'envoi d'e-mails côté serveur avec une configuration sécurisée.

**Contexte** : À appliquer pour standardiser l'usage de cette technologie dans les projets.

## Explication

Nodemailer est la librairie utilisée pour l'envoi d'e-mails côté serveur (Next.js API Routes, Server Actions). Elle fournit une API simple et supporte plusieurs fournisseurs d'e-mails (SMTP, Gmail, SendGrid, etc.).

**Principes clés :**

- **Configuration centralisée** : créer un transporter dans `lib/nodemailer.ts`.
- **Variables d'environnement** : stocker les identifiants SMTP de manière sécurisée.
- **Templates React Email** : utiliser React Email pour les templates HTML.
- **Côté serveur uniquement** : ne jamais exposer les credentials côté client.
- **Gestion d'erreurs** : toujours gérer les erreurs d'envoi.

**Installation :**

```bash
npm install nodemailer
npm install --save-dev @types/nodemailer
```

## Exemple de mise en pratique

**Configuration du transporter :**

```ts
// src/lib/nodemailer.ts
import nodemailer from "nodemailer";
import { env } from "@/config/env";

export const transporter = nodemailer.createTransport({
  host: env.SMTP_HOST,
  port: env.SMTP_PORT,
  secure: env.SMTP_PORT === 465, // true pour port 465, false pour les autres
  auth: {
    user: env.SMTP_USER,
    pass: env.SMTP_PASSWORD,
  },
});

// Vérifier la connexion
transporter.verify((error) => {
  if (error) {
    console.error("SMTP connection error:", error);
  } else {
    console.log("SMTP ready to send emails");
  }
});
```

**Variables d'environnement :**

```env
# .env.local
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your-email@gmail.com
SMTP_PASSWORD=your-app-password
SMTP_FROM=noreply@lyksia.com
```

**Service d'envoi d'e-mails :**

```ts
// src/features/emails/services/email-service.ts
import { transporter } from "@/lib/nodemailer";
import { env } from "@/config/env";

interface SendEmailOptions {
  to: string;
  subject: string;
  html: string;
  text?: string;
}

export async function sendEmail({ to, subject, html, text }: SendEmailOptions) {
  try {
    const info = await transporter.sendMail({
      from: env.SMTP_FROM,
      to,
      subject,
      html,
      text: text || html.replace(/<[^>]*>/g, ""), // Fallback text
    });

    console.log("Email sent:", info.messageId);
    return { success: true, messageId: info.messageId };
  } catch (error) {
    console.error("Failed to send email:", error);
    throw new Error("Failed to send email");
  }
}
```

**Envoi d'e-mail de bienvenue :**

```ts
// src/features/auth/services/welcome-email.ts
import { sendEmail } from "@/features/emails/services/email-service";

export async function sendWelcomeEmail(userEmail: string, userName: string) {
  const html = `
    <div style="font-family: Arial, sans-serif;">
      <h1>Welcome to Lyksia, ${userName}!</h1>
      <p>Thank you for signing up.</p>
      <a href="https://lyksia.com/dashboard" style="padding: 10px 20px; background-color: #3b82f6; color: white; text-decoration: none; border-radius: 5px;">
        Go to Dashboard
      </a>
    </div>
  `;

  await sendEmail({
    to: userEmail,
    subject: "Welcome to Lyksia!",
    html,
  });
}
```

**Avec React Email (template) :**

```tsx
// emails/welcome.tsx
import { Html, Button } from "@react-email/components";

interface WelcomeEmailProps {
  userName: string;
}

export function WelcomeEmail({ userName }: WelcomeEmailProps) {
  return (
    <Html>
      <h1>Welcome to Lyksia, {userName}!</h1>
      <p>Thank you for signing up.</p>
      <Button href="https://lyksia.com/dashboard">Go to Dashboard</Button>
    </Html>
  );
}
```

```ts
// src/features/auth/services/welcome-email.ts
import { render } from "@react-email/render";
import { WelcomeEmail } from "@/emails/welcome";
import { sendEmail } from "@/features/emails/services/email-service";

export async function sendWelcomeEmail(userEmail: string, userName: string) {
  const html = render(<WelcomeEmail userName={userName} />);

  await sendEmail({
    to: userEmail,
    subject: "Welcome to Lyksia!",
    html,
  });
}
```

**API Route pour envoi d'e-mail :**

```ts
// app/api/emails/send-welcome/route.ts
import { NextResponse } from "next/server";
import { sendWelcomeEmail } from "@/features/auth/services/welcome-email";

export async function POST(request: Request) {
  const { email, name } = await request.json();

  try {
    await sendWelcomeEmail(email, name);
    return NextResponse.json({ success: true });
  } catch (error) {
    return NextResponse.json(
      { error: "Failed to send email" },
      { status: 500 }
    );
  }
}
```

## Variantes ou exceptions

- Les projets avec un volume important d'e-mails peuvent utiliser des services dédiés (SendGrid, Mailgun).
- Les projets sans besoin d'e-mails peuvent se passer de Nodemailer.

## Liens / Références

- [Nodemailer Documentation](https://nodemailer.com/)
- [React Email](https://react.email/)
- [Gmail SMTP Setup](https://nodemailer.com/usage/using-gmail/)
