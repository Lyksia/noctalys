---
alwaysApply: false
description: Payment management and Stripe webhooks
---

# Stripe

**Objectif** : Standardiser l'usage de Stripe pour la gestion des paiements et des webhooks de manière sécurisée.

**Contexte** : À appliquer pour standardiser l'usage de cette technologie dans les projets.

## Explication

Stripe est le système de paiement utilisé pour tous les projets nécessitant des transactions financières. Il fournit une API sécurisée pour les paiements, abonnements et webhooks.

**Principes clés :**

- **Clés séparées** : utiliser les clés de test en développement, les clés de production en production.
- **Côté serveur** : ne jamais exposer la clé secrète côté client.
- **Webhooks** : toujours valider les webhooks avec la signature Stripe.
- **Idempotence** : gérer les requêtes en doublon avec des clés d'idempotence.
- **Gestion d'erreurs** : toujours gérer les erreurs Stripe de manière cohérente.

**Installation :**

```bash
npm install stripe
npm install --save-dev @stripe/stripe-js
```

## Exemple de mise en pratique

**Configuration Stripe :**

```ts
// src/lib/stripe.ts
import Stripe from "stripe";
import { env } from "@/config/env";

export const stripe = new Stripe(env.STRIPE_SECRET_KEY, {
  apiVersion: "2024-11-20.acacia",
  typescript: true,
});
```

**Variables d'environnement :**

```env
# .env.local
STRIPE_SECRET_KEY=sk_test_...
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_test_...
STRIPE_WEBHOOK_SECRET=whsec_...
```

**Création d'un Payment Intent :**

```ts
// app/api/payments/create-intent/route.ts
import { NextResponse } from "next/server";
import { stripe } from "@/lib/stripe";

export async function POST(request: Request) {
  const { amount, currency = "eur" } = await request.json();

  try {
    const paymentIntent = await stripe.paymentIntents.create({
      amount: amount * 100, // Montant en centimes
      currency,
      automatic_payment_methods: {
        enabled: true,
      },
    });

    return NextResponse.json({ clientSecret: paymentIntent.client_secret });
  } catch (error) {
    console.error("Stripe error:", error);
    return NextResponse.json(
      { error: "Failed to create payment intent" },
      { status: 500 }
    );
  }
}
```

**Client-side (React) :**

```tsx
// src/features/payment/components/checkout-form.tsx
"use client";

import { useState } from "react";
import { loadStripe } from "@stripe/stripe-js";
import { Elements, PaymentElement, useStripe, useElements } from "@stripe/react-stripe-js";
import { env } from "@/config/env";

const stripePromise = loadStripe(env.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY);

function CheckoutForm() {
  const stripe = useStripe();
  const elements = useElements();
  const [isProcessing, setIsProcessing] = useState(false);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();

    if (!stripe || !elements) return;

    setIsProcessing(true);

    const { error } = await stripe.confirmPayment({
      elements,
      confirmParams: {
        return_url: `${window.location.origin}/payment/success`,
      },
    });

    if (error) {
      console.error(error);
      setIsProcessing(false);
    }
  };

  return (
    <form onSubmit={handleSubmit}>
      <PaymentElement />
      <button type="submit" disabled={!stripe || isProcessing}>
        {isProcessing ? "Processing..." : "Pay now"}
      </button>
    </form>
  );
}

export function CheckoutPage({ clientSecret }: { clientSecret: string }) {
  return (
    <Elements stripe={stripePromise} options={{ clientSecret }}>
      <CheckoutForm />
    </Elements>
  );
}
```

**Webhook Stripe :**

```ts
// app/api/webhooks/stripe/route.ts
import { NextResponse } from "next/server";
import { headers } from "next/headers";
import { stripe } from "@/lib/stripe";
import { env } from "@/config/env";

export async function POST(request: Request) {
  const body = await request.text();
  const signature = headers().get("stripe-signature");

  if (!signature) {
    return NextResponse.json({ error: "No signature" }, { status: 400 });
  }

  let event;

  try {
    event = stripe.webhooks.constructEvent(
      body,
      signature,
      env.STRIPE_WEBHOOK_SECRET
    );
  } catch (error) {
    console.error("Webhook signature verification failed:", error);
    return NextResponse.json({ error: "Invalid signature" }, { status: 400 });
  }

  // Gérer les événements
  switch (event.type) {
    case "payment_intent.succeeded":
      const paymentIntent = event.data.object;
      console.log("Payment succeeded:", paymentIntent.id);
      // Mettre à jour la base de données
      break;

    case "payment_intent.payment_failed":
      console.log("Payment failed:", event.data.object.id);
      // Notifier l'utilisateur
      break;

    case "customer.subscription.created":
      const subscription = event.data.object;
      console.log("Subscription created:", subscription.id);
      break;

    default:
      console.log(`Unhandled event type: ${event.type}`);
  }

  return NextResponse.json({ received: true });
}
```

**Création d'un abonnement :**

```ts
// app/api/subscriptions/create/route.ts
import { NextResponse } from "next/server";
import { stripe } from "@/lib/stripe";

export async function POST(request: Request) {
  const { customerId, priceId } = await request.json();

  try {
    const subscription = await stripe.subscriptions.create({
      customer: customerId,
      items: [{ price: priceId }],
      payment_behavior: "default_incomplete",
      payment_settings: { save_default_payment_method: "on_subscription" },
      expand: ["latest_invoice.payment_intent"],
    });

    return NextResponse.json({
      subscriptionId: subscription.id,
      clientSecret: (subscription.latest_invoice as any).payment_intent.client_secret,
    });
  } catch (error) {
    console.error("Stripe error:", error);
    return NextResponse.json(
      { error: "Failed to create subscription" },
      { status: 500 }
    );
  }
}
```

**Création d'un client :**

```ts
// src/features/payment/services/stripe-service.ts
import { stripe } from "@/lib/stripe";

export async function createStripeCustomer(email: string, name: string) {
  const customer = await stripe.customers.create({
    email,
    name,
  });

  return customer.id;
}
```

## Variantes ou exceptions

- Les projets sans paiements peuvent se passer de Stripe.
- Les projets avec d'autres besoins de paiement peuvent utiliser PayPal, Square, etc.

## Liens / Références

- [Stripe Documentation](https://stripe.com/docs)
- [Stripe Webhooks](https://stripe.com/docs/webhooks)
- [Stripe with Next.js](https://stripe.com/docs/payments/quickstart)
