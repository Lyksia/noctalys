---
id: quality/ci-template
category: quality
title: Template GitHub Actions
status: draft
tags: [quality, ci-cd, github-actions, template, configuration]
---

# Template GitHub Actions

**Objectif** : Expliquer le fichier `.github/workflows/ci.yml` et documenter ses modifications possibles selon les besoins du projet.
**Contexte** : À appliquer pour assurer la qualité et la fiabilité du code.

## Explication

Le fichier `.github/workflows/ci.yml` est un template standard qui définit le pipeline de qualité. Il est conçu pour être réutilisable et facilement adaptable selon les spécificités du projet.

**Structure du template :**

1. **Metadata** : nom du workflow, déclencheurs
2. **Jobs** : tâches à exécuter (lint, test, build)
3. **Steps** : étapes détaillées de chaque job
4. **Actions** : réutilisation d'actions GitHub

**Sections modifiables :**

* **Branches** : ajouter/retirer des branches surveillées
* **Version Node** : changer la version de Node.js
* **Scripts** : adapter les commandes npm selon le projet
* **Cache** : optimiser le cache (npm, pnpm, yarn)
* **Matrix strategy** : tester sur plusieurs versions de Node
* **Environnement** : ajouter des variables d'environnement
* **Notifications** : intégrer Slack, Discord, email

**Quand modifier le template :**

* Projet utilisant pnpm ou yarn au lieu de npm
* Tests nécessitant une base de données (PostgreSQL, Redis)
* Variables d'environnement requises pour les tests
* Déploiement automatique après le build
* Ajout d'étapes spécifiques (Lighthouse, security scan)
* Tests E2E avec Playwright ou Cypress

## Exemple de mise en pratique

**Template de base :**

```yaml
# .github/workflows/ci.yml
name: CI

on:
  push:
    branches: ['**']  # Modifier : limiter à certaines branches
  pull_request:
    branches: [main, dev]  # Modifier : ajouter d'autres branches
  workflow_dispatch:

jobs:
  quality:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [20]  # Modifier : tester plusieurs versions [18, 20, 22]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'  # Modifier : 'pnpm' ou 'yarn' si nécessaire

      - name: Install dependencies
        run: npm ci  # Modifier : pnpm install --frozen-lockfile

      - name: Lint code
        run: npm run lint

      - name: Check formatting
        run: npm run format:check

      - name: Run tests with coverage
        run: npm run test:coverage

      - name: Build project
        run: npm run build
```

**Modifications courantes :**

**1. Utiliser pnpm :**

```yaml
- name: Setup pnpm
  uses: pnpm/action-setup@v2
  with:
    version: 8

- name: Setup Node.js
  uses: actions/setup-node@v4
  with:
    node-version: 20
    cache: 'pnpm'

- name: Install dependencies
  run: pnpm install --frozen-lockfile
```

**2. Ajouter une base de données PostgreSQL :**

```yaml
jobs:
  quality:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: testdb
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      # ... autres steps

      - name: Run tests
        env:
          DATABASE_URL: postgresql://testuser:testpass@localhost:5432/testdb
        run: npm run test:coverage
```

**3. Ajouter des variables d'environnement :**

```yaml
- name: Run tests
  env:
    NODE_ENV: test
    DATABASE_URL: ${{ secrets.DATABASE_URL }}
    API_KEY: ${{ secrets.API_KEY }}
  run: npm run test:coverage
```

**4. Tester sur plusieurs versions Node :**

```yaml
strategy:
  matrix:
    node-version: [18, 20, 22]
    os: [ubuntu-latest, windows-latest, macos-latest]

runs-on: ${{ matrix.os }}
```

**5. Paralléliser les jobs :**

```yaml
jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      # Installation + lint

  test:
    runs-on: ubuntu-latest
    steps:
      # Installation + tests

  build:
    runs-on: ubuntu-latest
    needs: [lint, test]  # Attend que lint et test soient OK
    steps:
      # Installation + build
```

**6. Ajouter des tests E2E :**

```yaml
- name: Install Playwright
  run: npx playwright install --with-deps

- name: Run E2E tests
  run: npm run test:e2e

- name: Upload test results
  if: always()
  uses: actions/upload-artifact@v3
  with:
    name: playwright-report
    path: playwright-report/
```

**7. Déploiement automatique (Vercel) :**

```yaml
deploy:
  runs-on: ubuntu-latest
  needs: [quality]
  if: github.ref == 'refs/heads/main'
  steps:
    - uses: actions/checkout@v4
    - uses: amondnet/vercel-action@v25
      with:
        vercel-token: ${{ secrets.VERCEL_TOKEN }}
        vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
        vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
        vercel-args: '--prod'
```

## Variantes ou exceptions

* Projets sans tests : retirer l'étape de tests (temporaire, à corriger)
* Projets avec linting personnalisé : adapter les scripts
* Projets nécessitant des secrets : utiliser GitHub Secrets
* Projets avec Turborepo : adapter pour monorepo
* Projets avec Docker : ajouter des étapes de build et push d'images

## Liens / Références

* https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions
* https://github.com/actions/setup-node
* https://github.com/pnpm/action-setup
* https://docs.github.com/en/actions/using-containerized-services
* Documentation interne : `/docs/ci-cd.md`
